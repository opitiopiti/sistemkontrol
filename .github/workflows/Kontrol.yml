name: Step 5 Ã‡alÄ±ÅŸtÄ±r (Paralel)

on:
  workflow_dispatch:  # Manuel olarak tetiklenmesi iÃ§in

jobs:
  run-scripts:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
    steps:
      - name: Checkout public repo (main)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          ref: main

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Clone Private Py Repo
        run: git clone https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/opitiopiti/Py.git private_py

      - name: Install Shared Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 lxml playwright aiohttp aiofiles dotenv httpx
          playwright install

      - name: Run Scripts in Controlled Parallel Batches
        run: |
          set +e
          
          echo "ðŸ”„ Batch 1 baÅŸlÄ±yor (HDFilmSite & AnimeHeaven & AnimeNoSub & SetFilmÄ°zle & Diziyo)"
          # ( python private_py/series/hdfilmsite/yenibolumler.py || true ) &
          # ( python private_py/anime/ingilizce/animeheaven/yenibolumler.py || true ) &
          ( python private_py/anime/ingilizce/animenosub/yenibolumler.py || true ) &
          ( python private_py/series/setfilmizledizi/yenibolumler.py || true ) &
          ( python private_py/series/diziyo/yenibolumler.py || true ) &
          wait
          
          echo "ðŸ”„ Batch 2 baÅŸlÄ±yor (Dizigom & Dizipall & SezonlukDizi & YabancÄ±Diziler)"
          ( python private_py/series/dizigom/yenibolumler.py || true ) &
          ( python private_py/series/dizipall/yenibolumler.py || true ) &
          ( python private_py/series/sezonlukdizi/yenibolumler.py || true ) &
          ( python private_py/series/yabancidiziler/yenibolumler.py || true ) &
          # ( python private_py/series/dizipal/yenibolumler.py || true ) &
          wait
          
          echo "ðŸ”„ Batch 3 baÅŸlÄ±yor (HDFilmCehennemi & Dizilife)"
          
          ( python private_py/series/hdfilmcehennemi/yenibolumler.py || true ) &          
          # ( python private_py/series/dizilife/yenibolumler.py || true ) &
          # ( python private_py/anime/anizm/yenibolumler.py || true ) & # Kod hatasÄ± mevcut ÅŸuanda Ã§Ã¶zmeye gerek yok
          
          wait
          
          echo "âœ… TÃ¼m scriptler tamamlandÄ±.."

      - name: Clone the hidden repo (sistemkontrolm3u)
        run: |
          git clone https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/opitiopiti/sistemkontrolm3u.git
          cd sistemkontrolm3u

      - name: Sync outputs to systemkontrolm3u
        run: |
          # Dizigom
          [ -d "dizigom" ] && rsync -a dizigom/ sistemkontrolm3u/dizigom/
          
          # Anizm
          [ -d "anizm" ] && rsync -a anizm/ sistemkontrolm3u/anizm/
          
          # AnimeNoSub
          [ -d "animenosub" ] && rsync -a animenosub/ sistemkontrolm3u/animenosub/
          
          # SetFilmÄ°zleDizi
          [ -d "setfilmizledizi" ] && rsync -a setfilmizledizi/ sistemkontrolm3u/setfilmizledizi/
          
          # DiziYo
          [ -d "diziyo" ] && rsync -a diziyo/ sistemkontrolm3u/diziyo/
          
          # DiziPall
          [ -d "dizipall" ] && rsync -a dizipall/ sistemkontrolm3u/dizipall/
          
          # HDFilmsite
          [ -d "yereldiziler" ] && rsync -a yereldiziler/ sistemkontrolm3u/yereldiziler/
          
          # HDFilmCehennemi
          [ -d "hdfilmcehennemi" ] && rsync -a hdfilmcehennemi/ sistemkontrolm3u/hdfilmcehennemi/
          
          # YabancÄ±Diziler
          [ -d "yabancidiziler" ] && rsync -a yabancidiziler/ sistemkontrolm3u/yabancidiziler/
          
          # SezonlukDÄ°zi
          [ -d "sdizi" ] && rsync -a sdizi/ sistemkontrolm3u/sdizi/
          
          # Dizipal
          [ -d "dizipal" ] && rsync -a dizipal/ sistemkontrolm3u/dizipal/
          
          # AnimeHeaven
          [ -d "animeheaven" ] && rsync -a animeheaven/ sistemkontrolm3u/animeheaven/
          
          # Dizilife
          [ -d "dizilife" ] && rsync -a dizilife/ sistemkontrolm3u/dizilife/

      - name: Commit and Push Changes to Repo
        run: |
          cd sistemkontrolm3u
          
          # Git add all changes
          git add .
          
          # Commit the changes
          git commit -m "Sync updated outputs from scripts" || echo "No changes to commit"
          
          # Push the changes
          git push https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/opitiopiti/sistemkontrolm3u.git
