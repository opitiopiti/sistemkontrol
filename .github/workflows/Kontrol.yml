name: Step 5 Ã‡alÄ±ÅŸtÄ±r (Paralel)

on:
  workflow_dispatch:  # Manuel olarak tetiklenmesi iÃ§in

jobs:
  run-scripts:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
    steps:
      - name: Checkout public repo (main)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          ref: main

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Clone Private Py Repo
        run: git clone https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/opitiopiti/Py.git private_py

      - name: Install Shared Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 lxml playwright aiohttp aiofiles dotenv httpx
          playwright install

      - name: Run Scripts in Controlled Parallel Batches
        run: |
          set +e
          
          echo "ðŸ”„ Batch 1 baÅŸlÄ±yor (HDFilmSite & AnimeHeaven & AnimeNoSub & SetFilmÄ°zle & Diziyo)"
          # ( python private_py/series/hdfilmsite/yenibolumler.py || true ) &
          # ( python private_py/anime/ingilizce/animeheaven/yenibolumler.py || true ) &
          ( python private_py/anime/ingilizce/animenosub/yenibolumler.py || true ) &
          ( python private_py/series/setfilmizledizi/yenibolumler.py || true ) &
          ( python private_py/series/diziyo/yenibolumler.py || true ) &
          wait
          
          echo "ðŸ”„ Batch 2 baÅŸlÄ±yor (Dizigom & Dizipall & SezonlukDizi & YabancÄ±Diziler)"
          ( python private_py/series/dizigom/yenibolumler.py || true ) &
          ( python private_py/series/dizipall/yenibolumler.py || true ) &
          ( python private_py/series/sezonlukdizi/yenibolumler.py || true ) &
          ( python private_py/series/yabancidiziler/yenibolumler.py || true ) &
          # ( python private_py/series/dizipal/yenibolumler.py || true ) &
          wait
          
          echo "ðŸ”„ Batch 3 baÅŸlÄ±yor (HDFilmCehennemi & Dizilife)"
          
          ( python private_py/series/hdfilmcehennemi/yenibolumler.py || true ) &          
          # ( python private_py/series/dizilife/yenibolumler.py || true ) &
          # ( python private_py/anime/anizm/yenibolumler.py || true ) & # Kod hatasÄ± mevcut ÅŸuanda Ã§Ã¶zmeye gerek yok
          
          wait
          
          echo "âœ… TÃ¼m scriptler tamamlandÄ±.."

      - name: Commit and Push All JSONs
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git config status.showUntrackedFiles no
          git add **/*.json || echo "No JSON files"
          git commit -m "TÃ¼m JSON dosyalarÄ± gÃ¼ncellendi [auto]" || echo "No changes"
          
          # Retry push up to 5 times with 10s delay
          for i in {1..5}; do
            git push origin main && break
            echo "Push failed, retrying in 10s..."
            sleep 10
          done

      - name: Sync All Outputs to Private Repo
        run: |
          git clone https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/opitiopiti/sistemkontrolm3u.git privaate_m3u8file
          
          # TÃ¼m dosyalarÄ± kopyalÄ±yoruz
          cp -r * privaate_m3u8file/ || echo "No files to copy"
          
          cd privaate_m3u8file
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # TÃ¼m dosyalarÄ± commit et
          git add . || echo "No files to commit"
          git commit -m "Auto update with all files" || echo "No changes to commit"
          
          # DeÄŸiÅŸiklikleri push et
          git push origin main
